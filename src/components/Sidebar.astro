---
import { getCollection } from 'astro:content';

interface Props {
  currentCategory?: string;
  currentArticle?: string;
}

const { currentCategory, currentArticle } = Astro.props;

const categories = await getCollection('categories');
const articles = await getCollection('articles');

const sortedCategories = categories.sort((a, b) => a.data.order - b.data.order);

const currentCategoryArticles = currentCategory
  ? articles
      .filter(article => article.data.category === categories.find(c => c.data.slug === currentCategory)?.data.title)
      .sort((a, b) => a.data.order - b.data.order)
  : [];

const isDictionary = currentCategory === 'dictionary';

const dictionaryArticles = articles.filter(article => article.data.category === 'Dictionary');
const lettersWithEntries = [...new Set(dictionaryArticles.map(a => a.data.title.charAt(0).toUpperCase()))].sort();

const currentPath = Astro.url.pathname;
const letterMatch = currentPath.match(/\/dictionary\/([a-z])$/i);
const currentLetter = letterMatch ? letterMatch[1].toUpperCase() : (currentPath === '/dictionary' || currentPath === '/dictionary/' ? 'A' : null);
---

<nav class="sidebar-nav">
  <div class="categories-section">
    <h2 class="section-title">Topics</h2>
    <ul class="category-list">
      {sortedCategories.map(category => (
        <li>
          <a
            href={`/${category.data.slug}`}
            class:list={['category-link', { active: currentCategory === category.data.slug }]}
          >
            {category.data.title}
          </a>
        </li>
      ))}
    </ul>
  </div>

  {isDictionary ? (
    <div class="articles-section">
      <h2 class="section-title">Contents</h2>
      <ul class="alphabet-list">
        {['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'].map(letter => (
          <li>
            {lettersWithEntries.includes(letter) ? (
              <a
                href={letter === 'A' ? '/dictionary' : `/dictionary/${letter.toLowerCase()}`}
                class:list={['letter-link', { active: currentLetter === letter }]}
              >
                {letter}
              </a>
            ) : (
              <span class="letter-link disabled">{letter}</span>
            )}
          </li>
        ))}
      </ul>
    </div>
  ) : (
    currentCategory && currentCategoryArticles.length > 0 && (
      <div class="articles-section">
        <h2 class="section-title">Contents</h2>
        <ul class="article-list">
          {currentCategoryArticles.map(article => (
            <li>
              <a
                href={`/${currentCategory}/${article.data.slug}`}
                class:list={['article-link', { active: currentArticle === article.data.slug }]}
              >
                {article.data.order}. {article.data.title}
              </a>
            </li>
          ))}
        </ul>
      </div>
    )
  )}
</nav>

<style>
  .sidebar-nav {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .section-title {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #6b7280;
    margin-bottom: 0.75rem;
    font-weight: 600;
  }

  .category-list,
  .article-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .category-link,
  .article-link {
    display: block;
    padding: 0.2rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    color: #44403c;
    transition: background-color 0.15s;
    border-bottom: none;
  }

  .category-link:hover,
  .article-link:hover {
    background: #e5e7eb;
    color: #111827;
  }

  .category-link.active,
  .article-link.active {
    background: #e5e7eb;
    font-weight: 500;
    color: #111827;
  }

  .articles-section {
    padding-top: 1rem;
    border-top: 1px solid #e5e7eb;
  }

  .alphabet-list {
    list-style: none;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.25rem;
  }

  .letter-link {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #44403c;
    transition: background-color 0.15s;
    border-bottom: none;
    text-decoration: none;
  }

  .letter-link:hover:not(.disabled) {
    background: #e5e7eb;
    color: #111827;
  }

  .letter-link.active {
    background: #44403c;
    color: #fff;
  }

  .letter-link.disabled {
    color: #d1d5db;
    cursor: default;
  }
</style>
